<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>WebGL Triangle in Rust</title>
    <style>
        body{
            background-color: #444;
        }
        #canvas{
            /*width: 90vw;
            height: 90vh;*/
            /*width: 800px;
            height: 600px;*/
            margin-left: calc(50% - 600px);
        }
    </style>
    <script>
        let renderer = null;
        let is_renderer_free = true;

        function loadModel(modelPath) {
            if(!is_renderer_free){
                return;
            }

            is_renderer_free = false;
            fetch(`assets/${modelPath}`)
                .then(response => response.text())
                .then(modelData => {
                    renderer.load_model(modelData);
                    is_renderer_free = true;
                })
                .catch(error => {
                    console.error("Error loading model:", error);
                });
        }

        function changeShading(shading){
            if(!is_renderer_free){
                return;
            }
            is_renderer_free = false;
            renderer.change_shading(shading);
            is_renderer_free = true;
        }
    </script>
</head>
<body>
    <canvas id="canvas" width="1200" height="800"></canvas>

    <div id = "menu">
        <form>
        <label for="models">Load model:</label>
        <select id="models" name="models" onchange="loadModel(this.value)">
            <option value="teapot.obj">teapot.obj</option>
            <option value="gear.obj">gear.obj</option>
        </select>
        </form>

        <form>
            <label>
                Shading:
            </label>
            <label>
                <input type="radio" name="shading" value="smooth" checked onchange="changeShading(this.value)"> Smooth
            </label>
            <label>
                <input type="radio" name="shading" value="flat" onchange="changeShading(this.value)"> Flat
            </label>
        </form>
    </div>

    <script type="module">
        import init, {Renderer} from "./pkg/rust_webgl.js";
        
        init().then(async () => {
            renderer = new Renderer();

            loadModel("teapot.obj");

            requestAnimationFrame(call_anim_frame);

            let mouseX = 0, mouseY = 0, mouseDown = false, mouseWheel = 0;
            document.addEventListener("wheel", (e) => mouseWheel = Math.sign(e.deltaY));
            document.addEventListener("mousedown", (e) => mouseDown = true);//TODO needs event
            document.addEventListener("mouseup", (e) => mouseDown = false);//TODO needs event
            document.addEventListener("mousemove", (e) => {
                mouseX = e.clientX;
                mouseY = e.clientY;
            });

            function call_anim_frame() {
                if(is_renderer_free){
                    renderer.update(mouseDown, mouseX, mouseY, mouseWheel);
                    renderer.render();
                }

                mouseWheel = 0;

                requestAnimationFrame(call_anim_frame);
            }
        }).catch((error) => {
            console.error("Initialization failed:", error);
        });
    </script>
</body>
</html>
